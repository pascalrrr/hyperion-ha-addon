#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: Hyperion (Next Generation)
# Send Hyperion Discovery information to Home Assistant
# ==============================================================================
declare config
web_port="$(bashio::addon.port 8091)"
web_port=${web_port:-8091}
host_name=$(bashio::addon.hostname)

# Wait for Hyperion Web UI to come up
bashio::net.wait_for "$web_port" 127.0.0.1 300

config=$(
    bashio::var.json \
        host "$host_name" \
        port "^$web_port"
)

# Discovery won't fill this because the integration doesn't
# support Supervisor discovery, this will need to be manually entered.
if bashio::discovery "hyperion" "${config}" > /dev/null; then
    bashio::log.info "Successfully sent discovery information to Home Assistant."
    bashio::log.info "Note: The Hyperion Integration doesn't support Add-on discovery,"
    bashio::log.info "you will have to enter '$host_name' for the Host field manually."
else
    bashio::log.warn "Failed to send discovery information to Home Assistant."
fi