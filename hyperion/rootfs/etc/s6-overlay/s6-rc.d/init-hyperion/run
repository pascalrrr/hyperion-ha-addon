#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: Hyperion (Next Generation)
# Configure Hyperion for running behind NGINX with ingress
# ==============================================================================
bashio::log.info "Configuring Hyperion..."
configDir="/usr/share/hyperion"
dataDir="/data/hyperion"
entryPoint="$(bashio::addon.ingress_entry)"
web_port="$(bashio::addon.port 8091)"
web_port=${web_port:-8091}

# Patch the Hyperion websocket URL on init because this URL may be unknown at build.
# This should only ever happen on first run, but the Supervisor docs are not 100% clear...
if ! (grep -Fxq "$entryPoint" "$configDir/webconfig/js/hyperion.js"); then
    bashio::log.info "Patching websocket..."
    # Back-up in case something goes really wrong...
    cp "$configDir/webconfig/js/hyperion.js" "$configDir/webconfig/js/unpatched.js"
    awk "NR==103{
        print \"      let wsUrl = document.location.hostname + \\\":\\\" + window.jsonPort;\"
        print \"      if (window.jsonPort !== '$web_port') wsUrl += '$entryPoint/';\"
        print \"      wsUrl = (document.location.protocol == \\\"https:\\\") ? \\\"wss://\\\" + wsUrl : \\\"ws://\\\" + wsUrl;\"
        print \"      window.websocket = new WebSocket(wsUrl);\"
        next} {print}" $configDir/webconfig/js/unpatched.js > $configDir/webconfig/js/hyperion.js
fi

# More Add-on patch work to ensure that the document root and ports are set correctly for
# running behind NGINX with Ingress.
if [ ! -f "$dataDir/db/hyperion.db" ]; then
    bashio::log.info "Applying default configuration..."
    hyperiond --importConfig $configDir/settings.default.json --userdata $dataDir
fi

# Generate a Generic SSL cert for Hyperion over SSL, which is only used
# if the user exposes the SSL web port in Add-on configuration.
# Better than using the pre-generated cert to some extent.
if [ ! -f "/ssl/hyperion/crt.pem" ]; then
    bashio::log.info "Generating SSL Certificates..."
    # Same command used by Hyperion to generate SSL Certificates, filenames changed.
    openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes \
    -keyout key.pem -out crt.pem -extensions san -config \
    <(echo "[req]"; \
    echo distinguished_name=req; \
    echo "[san]"; \
    echo subjectAltName=DNS:hyperion.hass.io,IP:127.0.0.1 \
    ) \
    -subj /CN=hyperion.hass.io
    [[ ! -d '/ssl/hyperion' ]] && mkdir /ssl/hyperion
    mv ./*.pem /ssl/hyperion
fi

rm /etc/init.d/hyperion